<!-- app/views/conversations/show.html.erb -->
<div class="max-w-4xl mx-auto h-screen flex flex-col border border-[#ffd369] rounded-lg">
  <% interlocutor = @conversation.interlocutor(current_user) %>

  <!-- Шапка чата -->
  <div class="bg-[#31363f] rounded-t-lg shadow-md p-4 border-b border-[#ffd369]">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <%= link_to conversations_path, class: "text-[#ffd369] hover:text-[#ffd369]/80" do %>
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
        <% end %>

        <div class="w-10 h-10 bg-gray-300 rounded-full"></div>
        <div>
          <h2 class="font-semibold text-lg text-[#ffd369]"><%= interlocutor.email %></h2>
          <p class="text-xs text-gray-500">онлайн</p>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-[#222831]  flex-1 overflow-y-auto p-4" id="messages">
    <% @messages.each do |message| %>
      <%= render 'messages/message', message: message, current_user_id: current_user.id %>
    <% end %>
  </div>

  <div class="bg-[#222831] rounded-b-lg shadow-md p-4">
    <%= form_with(
          model: [@conversation, @message],
          url: conversation_messages_path(@conversation),
          id: "message-form",
          local: false
        ) do |f| %>
      <div class="flex gap-2">
        <%= f.text_area :body,
            rows: 1,
            id: "message-input",
            placeholder: "Написать сообщение...",
            class: "flex-1 border border-[#ffd369] text-[#ffd369] rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none",
            required: true %>

        <%= f.submit "Отправить",
            id: "message-submit",
            class: "bg-[#ffd369] hover:bg-[#ffd369]/80 text-[#222831] px-6 py-2 rounded-lg cursor-pointer" %>
      </div>
    <% end %>
  </div>
</div>

<script type="module">
  import { createConsumer } from '<%= asset_path("actioncable.esm.js") %>'

  const consumer = createConsumer()
  const conversationId = <%= @conversation.id %>
  const currentUserId = <%= current_user.id %>

  function escapeHtml(text) {
    const div = document.createElement('div')
    div.textContent = text
    return div.innerHTML
  }

  function addMessageToDOM(element) {
    messagesContainer.appendChild(element)
    messagesContainer.scrollTop = messagesContainer.scrollHeight
  }

  const subscription = consumer.subscriptions.create(
    {
      channel: "ConversationChannel",
      conversation_id: conversationId
    },
    {
      received(data) {
        const temp = document.createElement("div")
        temp.innerHTML = data.message_html
        const messageElement = temp.querySelector(".message-item")

        if (messageElement) {
          const isMine = data.user_id === currentUserId

          if (isMine) {
            messageElement.classList.remove("justify-start")
            messageElement.classList.add("justify-end")

            const bubble = messageElement.querySelector(".message-bubble")
            if (bubble) {
              bubble.classList.remove("bg-[#ffd369]", "text-[#393e46]")
              bubble.classList.add("bg-[#393e46]", "text-[#ffd369]")
            }

            const time = messageElement.querySelector(".message-time")
            if (time) {
              time.classList.remove("text-gray-500")
              time.classList.add("text-blue-100")
            }

            const senderName = messageElement.querySelector(".sender-name")
            if (senderName) {
            senderName.classList.add("text-[#ffd369]")
            senderName.remove()
            }
          }

          addMessageToDOM(messageElement)
        }
      },
    }
  )

  const form = document.getElementById('message-form')
  const input = document.getElementById('message-input')
  const submitBtn = document.getElementById('message-submit')

  form.addEventListener('submit', async (e) => {
    e.preventDefault()

    const body = input.value.trim()

    submitBtn.disabled = true

    try {
      const formData = new FormData(form)

      const response = await fetch(form.action, {
        method: 'POST',
        headers: {
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
        },
        body: formData
      })

      if (response.ok) {

        input.value = ''
        input.style.height = 'auto'
      } else {
        const errorData = await response.json()
        alert("Ошибка отправки сообщения: " + (errorData.errors ? errorData.errors.join(', ') : 'Неизвестная ошибка'))
      }
    } catch (error) {
      alert("Ошибка соединения")
    } finally {
      submitBtn.disabled = false
    }
  })

  input.addEventListener('input', () => {
    input.style.height = 'auto'
    input.style.height = input.scrollHeight + 'px'
  })


  const messagesContainer = document.getElementById('messages')
  if (messagesContainer) {
    messagesContainer.scrollTop = messagesContainer.scrollHeight
  }
</script>
